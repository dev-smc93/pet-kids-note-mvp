# 알림장 기능 테스트 시나리오

## 사전 준비

1. **Supabase Storage**: `report-photos`, `pet-photos` 버킷 생성 (Storage > New bucket > Public). RLS 정책은 `supabase/storage_policies.sql` 참고
2. **Supabase Realtime**: `report_comments` 테이블을 Realtime publication에 추가 (Database > Publications > `supabase_realtime`에서 체크, 또는 `supabase/enable_realtime_report_comments.sql` 실행)
3. **푸시 알람 (선택)**: `npm run push:vapid`로 VAPID 키 생성 후 `.env`에 `NEXT_PUBLIC_VAPID_PUBLIC_KEY`, `VAPID_PRIVATE_KEY` 추가. 프로필 페이지에서 "알림 받기"로 구독
4. **시드 데이터**: `npm run db:seed` 실행 후 관리자/보호자 계정으로 로그인 가능한지 확인
5. **연결 상태**: 보호자의 반려동물이 관리자의 원에 **승인됨(APPROVED)** 상태로 연결되어 있어야 함

---

## 1. 관리자: 알림장 작성

### 1-1. 정상 작성 (텍스트만)

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 관리자 로그인 | 홈 화면 표시 |
| 2 | "알림장" 클릭 | 알림장 목록 화면 |
| 3 | FAB(연필 아이콘) 클릭 | 알림장 작성 → 원 선택 화면 |
| 4 | 원 선택 (해피펫 유치원 등) | 알림장 작성 폼 표시 |
| 5 | 대상 반려동물 선택 (드롭다운) | 선택된 반려동물 표시 |
| 6 | 내용 입력 (예: "오늘 산책 잘 다녀왔어요.") | 입력 내용 표시 |
| 7 | "작성" 버튼 클릭 | 알림장 목록으로 이동, 알림장 생성됨 |

### 1-2. 정상 작성 (텍스트 + 사진 1~10장)

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1~5 | 1-1과 동일 | - |
| 6 | 내용 입력 | - |
| 7 | "+" 클릭 후 이미지 1~10장 선택 (JPEG/PNG/WebP, 10MB 이하) | **즉시 미리보기** 표시, 백그라운드 업로드 |
| 8 | "작성" 버튼 클릭 | 알림장 목록으로 이동, 알림장 + 사진 저장됨. **보호자 구독 시 푸시 알림 발송** |

### 1-3. 유효성 검사

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 내용 비우고 "작성" 클릭 | "내용을 입력해주세요." 에러 |
| 2 | 사진 11장 첨부 시도 | 10장까지만 추가됨 (또는 "사진은 1~10장까지" 에러) |
| 3 | 10MB 초과 이미지 첨부 | "파일 크기는 10MB 이하여야 합니다." 에러 |
| 4 | 5,001자 이상 입력 | "내용은 5000자 이하여야 합니다." 에러 |

### 1-4. 알림장 작성 UI (원 선택, 생활기록)

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 원 선택 후 알림장 작성 폼 진입 | 헤더에 "알림장 작성 - [원 이름]" 표시 |
| 2 | 원 미선택 상태 | "알림장 작성(원 선택)" 표시 |
| 3 | 폼 하단 "생활기록" 버튼 클릭 | 오버레이 패널 슬라이드업 (아래→위) |
| 4 | 생활기록 입력 후 패널 닫기 | 입력 내용 폼에 반영 |

### 1-5. 연결된 반려동물 없음

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 관리자 로그인 → 알림장 → FAB 클릭 | 원 선택 화면 |
| 2 | 모든 원에 연결된 반려동물이 0인 경우 | "연결된 반려동물이 있는 원이 없습니다." 메시지 |
| 3 | 원 관리에서 반려동물 연결 승인 후 | `/reports/new`에서 해당 원 선택 가능 |

---

## 2. 보호자: 알림장 작성

### 2-0-1. 정상 작성 (생활기록 제외)

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 보호자 로그인 | 홈 화면 |
| 2 | "알림장" 클릭 → FAB(연필 아이콘) 클릭 | 알림장 작성 → 원 선택 화면 |
| 3 | 연결된 원 선택 | 알림장 작성 폼 표시 (생활기록 버튼 없음) |
| 4 | 대상 반려동물 선택, 내용 입력, (선택) 사진 첨부 | 입력 내용 표시 |
| 5 | "바로 등록" 클릭 | 알림장 목록으로 이동, 알림장 생성됨 |

### 2-0-2. 연결된 원 없음

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 보호자 로그인 → 알림장 → FAB 클릭 | 원 선택 화면 |
| 2 | 연결된 원이 없는 경우 | "연결된 원이 없습니다." + "원 검색에서 연결 요청하기" 링크 |

---

## 3. 보호자: 알림장 목록/상세

### 3-1. 알림장 목록 조회

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 보호자 로그인 | 홈 화면 |
| 2 | "알림장" 클릭 | 알림장 목록 화면 |
| 3 | 관리자가 작성한 알림장이 있는 경우 | 반려동물별 알림장 카드 표시 (미열람 시 "새 알림" 배지) |
| 4 | 알림장이 없는 경우 | "아직 받은 알림장이 없습니다." 메시지 |

### 3-1-1. 필터 (원 다중 선택, 내가 쓴 글만 보기)

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 관리자 로그인 → 알림장 목록 → 필터 버튼 클릭 | 필터 화면 |
| 2 | 원 선택: 체크박스로 여러 원 선택 | 선택된 원들만 체크 표시 |
| 3 | "전체 선택" / "선택 해제" 버튼 | 전체 선택 또는 모두 해제 |
| 4 | "내가 쓴 글만 보기" 토글 ON (관리자 전용) | 토글 활성화 |
| 5 | "적용" 클릭 | 선택한 원들의 알림장만 표시, mineOnly 시 내가 작성한 것만 |
| 6 | 아무 원도 선택하지 않고 적용 | 전체 알림장 표시 |

### 3-2. 알림장 상세 조회 (읽음 처리)

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 알림장 목록에서 카드 클릭 | 알림장 상세 화면 |
| 2 | 제목(고정) → 스크롤 영역(생활기록 → 이미지 → 내용) 순서로 표시 | 정상 표시 |
| 3 | 사진 2장 이상인 경우 | Swiper 슬라이더 + 점 인디케이터 |
| 4 | 스크롤 시 아래에 더 있는 경우 | 바운스 애니메이션 화살표 표시 (20px 이상 스크롤 시 숨김) |
| 5 | (미열람 알림장인 경우) | 자동으로 읽음 처리 API 호출 |
| 6 | 목록으로 돌아가기 | 해당 알림장 "새 알림" 배지 사라짐 |

### 3-3. 댓글 작성

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 알림장 상세 화면 | 댓글 섹션 표시 (알림창:댓글창 비율 3:2) |
| 2 | 댓글 입력 후 전송 버튼 클릭 | 댓글 목록에 추가됨, 스크롤 맨 아래로 이동. **상대방 구독 시 푸시 알림 발송** |
| 3 | 빈 댓글 전송 버튼 클릭 | 버튼 비활성화 |
| 4 | 시계 버튼 클릭 → 예약시간 선택 | 예약 모달 표시 (내일 8:30, 10:00, 15:00, 최근 예약, 직접입력) |
| 5 | 예약시간 선택 후 댓글 입력 → 전송 | 예약 댓글로 등록 (점선 테두리, "예약" 배지) |

### 3-4. 댓글 실시간 반영

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 알림장 상세 화면 A (관리자/보호자) | - |
| 2 | 다른 기기/탭에서 새 댓글 작성 | 새로고침 없이 A 화면에 즉시 반영 |
| 3 | 예약 댓글의 예약 시간 도래 | 새로고침 없이 일반 댓글로 전환됨 |

### 3-5. 댓글 액션 (내 댓글 vs 상대방 댓글)

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | **내 댓글** 클릭 | 액션 메뉴: 댓글 복사, 댓글 수정, 댓글 삭제, 취소 |
| 2 | **상대방 댓글** 클릭 | 액션 메뉴: 댓글 복사, 취소 (수정/삭제 숨김) |
| 3 | 댓글 복사 클릭 | 클립보드 복사 + 댓글 입력창에 내용 붙여넣기 |
| 4 | 댓글 수정 → 저장 | 수정 반영 |
| 5 | 댓글 삭제 → 확인 | 댓글 삭제됨 |
| 6 | 예약 댓글의 "예약 취소" 버튼 | 예약 취소 확인 후 삭제 |

### 3-6. 댓글창 UI

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 댓글이 많을 때 | 댓글 목록 영역 스크롤 가능 |
| 2 | 새 댓글 등록 시 | 자동으로 맨 아래로 스크롤 |
| 3 | 예약 완료 댓글 시간 표시 | 예약 시간(scheduledAt) 기준으로 표시 |

---

## 4. 관리자: 알림장 수정/삭제/재알림

### 4-1. 알림장 수정

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 관리자 로그인 → "알림장" 또는 원 상세에서 해당 알림장 진입 | - |
| 2 | 알림장 상세에서 "수정" 버튼 클릭 | 수정 폼 화면 |
| 3 | 내용/사진 수정 후 "저장" 클릭 | 상세 화면으로 이동, 수정 반영됨 |

### 4-2. 알림장 삭제

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 알림장 상세에서 "삭제" 버튼 클릭 | 확인 다이얼로그 표시 |
| 2 | "삭제" 확인 | 알림장 목록으로 이동, 해당 알림장 삭제됨 |
| 3 | "취소" 클릭 | 다이얼로그 닫힘 |

### 4-3. 재알림

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 보호자가 아직 읽지 않은 알림장 상세 (관리자 화면) | "재알림" 버튼 표시 |
| 2 | "재알림" 버튼 클릭 | "재알림 요청이 완료되었습니다." 메시지. **보호자 구독 시 푸시 알림 발송** |
| 3 | 보호자가 이미 읽은 알림장 | "재알림" 버튼 미표시 또는 "이미 열람한 보호자입니다." |

---

## 5. 푸시 알림

### 5-0. 푸시 구독

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 프로필 페이지 진입 | "푸시 알림" 섹션 표시 (VAPID 키 설정 시) |
| 2 | "알림 받기" 클릭 | 브라우저 알림 권한 요청 |
| 3 | 권한 허용 | "알림 구독이 완료되었습니다." 메시지 |
| 4 | "알림 해제" 클릭 | 구독 해제, "알림 구독이 해제되었습니다." 메시지 |

### 5-0-1. 푸시 발송 시점

| 시나리오 | 수신자 | 조건 |
|----------|--------|------|
| 알림장 등록 | 보호자 | 작성자 ≠ 보호자, 보호자 구독 시 |
| 댓글 등록 | 상대방 (관리자 또는 보호자) | 즉시 댓글(예약 아님), 상대방 구독 시 |
| 재알림 버튼 | 미열람 보호자 | 보호자 구독 시 |

---

## 6. 권한 검증

### 6-1. 보호자 → 관리자 전용 기능

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 보호자로 로그인 | - |
| 2 | `/reports/[id]/edit` 직접 접근 | 홈으로 리다이렉트 |
| 3 | `/groups`, `/groups/new` 등 관리자 전용 경로 직접 접근 | 홈으로 리다이렉트 |

### 6-2. 관리자 → 타 원 반려동물

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 관리자 A의 원에 연결되지 않은 반려동물 petId로 `POST /api/reports` | "해당 반려동물에 대한 작성 권한이 없습니다." 403 |

### 6-3. 보호자 → 타 반려동물 알림장

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 보호자 A로 로그인 | - |
| 2 | 보호자 B의 반려동물 알림장 ID로 `/reports/[id]` 접근 | 404 또는 "알림장을 찾을 수 없습니다." |

---

## 7. API 직접 테스트 (선택)

### cURL 예시

```bash
# 1. 알림장 목록 (보호자)
curl -X GET "http://localhost:3000/api/reports" \
  -H "Cookie: sb-xxx=..."  # Supabase 세션 쿠키

# 2. 알림장 작성 (관리자)
curl -X POST "http://localhost:3000/api/reports" \
  -H "Content-Type: application/json" \
  -H "Cookie: sb-xxx=..." \
  -d '{"petId":"<pet-uuid>","content":"오늘 산책 잘 다녔어요.","mediaUrls":[]}'

# 3. 읽음 처리 (보호자)
curl -X POST "http://localhost:3000/api/reports/<report-id>/read" \
  -H "Cookie: sb-xxx=..."
```

---

## 8. 체크리스트 요약

- [ ] 관리자: 알림장 작성 (텍스트만)
- [ ] 관리자: 알림장 작성 (텍스트 + 사진 1~10장)
- [ ] 관리자: 알림장 작성 UI (헤더 원 이름, 생활기록 오버레이 패널)
- [ ] 보호자: 알림장 작성 (생활기록 제외, 나머지 동일)
- [ ] 관리자: 알림장 수정
- [ ] 관리자: 알림장 삭제
- [ ] 관리자: 재알림 버튼
- [ ] 보호자: 알림장 목록 (미열람 배지)
- [ ] 보호자: 알림장 상세 + 자동 읽음 처리
- [ ] 알림장 상세 UI: Swiper 이미지 슬라이더, 스크롤 화살표
- [ ] 보호자/관리자: 댓글 작성/조회
- [ ] 댓글 예약 (시계 버튼, 예약 모달, 예약 취소)
- [ ] 댓글 실시간 반영 (Supabase Realtime)
- [ ] 댓글 액션: 내 댓글(복사/수정/삭제), 상대방 댓글(복사만)
- [ ] 댓글 복사 → 입력창 붙여넣기
- [ ] 댓글창 UI (알림창:댓글창 3:2, 스크롤, 새 댓글 시 맨 아래 스크롤)
- [ ] 권한: 보호자 → 관리자 전용 기능(수정/삭제, 원 관리) 차단
- [ ] 권한: 관리자 → 타 원 반려동물 차단
- [ ] 필터: 원 다중 선택 (체크박스), 전체 선택/선택 해제
- [ ] 필터: 내가 쓴 글만 보기 토글 (관리자 전용)
- [ ] 사진 업로드: 즉시 미리보기, 10MB 이하, 클라이언트 직접 업로드
- [ ] 푸시 알림: 프로필에서 알림 받기/해제
- [ ] 푸시 알림: 알림장 등록 시 보호자에게 발송
- [ ] 푸시 알림: 댓글 등록 시 상대방에게 발송
- [ ] 푸시 알림: 재알림 버튼 시 보호자에게 발송
