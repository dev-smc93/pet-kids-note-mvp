# 알림장 기능 테스트 시나리오

## 사전 준비

1. **Supabase Storage**: `report-photos` 버킷 생성 (Storage > New bucket > `report-photos` > Public)
2. **Supabase Realtime**: `report_comments` 테이블을 Realtime publication에 추가 (Database > Publications > `supabase_realtime`에서 체크, 또는 `supabase/enable_realtime_report_comments.sql` 실행)
3. **시드 데이터**: `npm run db:seed` 실행 후 관리자/보호자 계정으로 로그인 가능한지 확인
4. **연결 상태**: 보호자의 반려동물이 관리자의 원에 **승인됨(APPROVED)** 상태로 연결되어 있어야 함

---

## 1. 관리자: 알림장 작성

### 1-1. 정상 작성 (텍스트만)

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 관리자 로그인 | 홈 화면 표시 |
| 2 | "원 관리" 클릭 | 원 목록 표시 |
| 3 | 원 선택 (해피펫 유치원 등) | 원 상세 화면, 연결된 반려동물 목록 |
| 4 | "알림장 작성" 버튼 클릭 | 알림장 작성 폼 표시 |
| 5 | 대상 반려동물 선택 (드롭다운) | 선택된 반려동물 표시 |
| 6 | 내용 입력 (예: "오늘 산책 잘 다녀왔어요.") | 입력 내용 표시 |
| 7 | "작성" 버튼 클릭 | 원 상세로 이동, 알림장 생성됨 |

### 1-2. 정상 작성 (텍스트 + 사진 3~10장)

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1~5 | 1-1과 동일 | - |
| 6 | 내용 입력 | - |
| 7 | "+" 클릭 후 이미지 3장 선택 (JPEG/PNG/WebP) | 미리보기 표시 |
| 8 | "작성" 버튼 클릭 | 원 상세로 이동, 알림장 + 사진 저장됨 |

### 1-3. 유효성 검사

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 내용 비우고 "작성" 클릭 | "내용을 입력해주세요." 에러 |
| 2 | 사진 1장만 첨부 후 "작성" 클릭 | "사진은 3~10장까지 첨부 가능합니다." 에러 |
| 3 | 사진 11장 첨부 시도 | 10장까지만 추가됨 (또는 에러) |
| 4 | 5,001자 이상 입력 | "내용은 5000자 이하여야 합니다." 에러 |

### 1-4. 연결된 반려동물 없음

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 연결된 반려동물이 0인 원 선택 | "알림장 작성" 버튼 미표시 |
| 2 | 또는 URL 직접 입력 `/groups/[id]/reports/new` | "연결된 반려동물이 없어 알림장을 작성할 수 없습니다." 메시지 |

---

## 2. 보호자: 알림장 목록/상세

### 2-1. 알림장 목록 조회

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 보호자 로그인 | 홈 화면 |
| 2 | "알림장" 클릭 | 알림장 목록 화면 |
| 3 | 관리자가 작성한 알림장이 있는 경우 | 반려동물별 알림장 카드 표시 (미열람 시 "새 알림" 배지) |
| 4 | 알림장이 없는 경우 | "아직 받은 알림장이 없습니다." 메시지 |

### 2-2. 알림장 상세 조회 (읽음 처리)

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 알림장 목록에서 카드 클릭 | 알림장 상세 화면 |
| 2 | 내용, 사진, 작성자, 작성일 표시 | 정상 표시 |
| 3 | (미열람 알림장인 경우) | 자동으로 읽음 처리 API 호출 |
| 4 | 목록으로 돌아가기 | 해당 알림장 "새 알림" 배지 사라짐 |

### 2-3. 댓글 작성

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 알림장 상세 화면 | 댓글 섹션 표시 (알림창:댓글창 비율 3:2) |
| 2 | 댓글 입력 후 전송 버튼 클릭 | 댓글 목록에 추가됨, 스크롤 맨 아래로 이동 |
| 3 | 빈 댓글 전송 버튼 클릭 | 버튼 비활성화 |
| 4 | 시계 버튼 클릭 → 예약시간 선택 | 예약 모달 표시 (내일 8:30, 10:00, 15:00, 최근 예약, 직접입력) |
| 5 | 예약시간 선택 후 댓글 입력 → 전송 | 예약 댓글로 등록 (점선 테두리, "예약" 배지) |

### 2-4. 댓글 실시간 반영

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 알림장 상세 화면 A (관리자/보호자) | - |
| 2 | 다른 기기/탭에서 새 댓글 작성 | 새로고침 없이 A 화면에 즉시 반영 |
| 3 | 예약 댓글의 예약 시간 도래 | 새로고침 없이 일반 댓글로 전환됨 |

### 2-5. 댓글 액션 (내 댓글 vs 상대방 댓글)

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | **내 댓글** 클릭 | 액션 메뉴: 댓글 복사, 댓글 수정, 댓글 삭제, 취소 |
| 2 | **상대방 댓글** 클릭 | 액션 메뉴: 댓글 복사, 취소 (수정/삭제 숨김) |
| 3 | 댓글 복사 클릭 | 클립보드 복사 + 댓글 입력창에 내용 붙여넣기 |
| 4 | 댓글 수정 → 저장 | 수정 반영 |
| 5 | 댓글 삭제 → 확인 | 댓글 삭제됨 |
| 6 | 예약 댓글의 "예약 취소" 버튼 | 예약 취소 확인 후 삭제 |

### 2-6. 댓글창 UI

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 댓글이 많을 때 | 댓글 목록 영역 스크롤 가능 |
| 2 | 새 댓글 등록 시 | 자동으로 맨 아래로 스크롤 |
| 3 | 예약 완료 댓글 시간 표시 | 예약 시간(scheduledAt) 기준으로 표시 |

---

## 3. 관리자: 알림장 수정/삭제/재알림

### 3-1. 알림장 수정

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 관리자 로그인 → "알림장" 또는 원 상세에서 해당 알림장 진입 | - |
| 2 | 알림장 상세에서 "수정" 버튼 클릭 | 수정 폼 화면 |
| 3 | 내용/사진 수정 후 "저장" 클릭 | 상세 화면으로 이동, 수정 반영됨 |

### 3-2. 알림장 삭제

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 알림장 상세에서 "삭제" 버튼 클릭 | 확인 다이얼로그 표시 |
| 2 | "삭제" 확인 | 알림장 목록으로 이동, 해당 알림장 삭제됨 |
| 3 | "취소" 클릭 | 다이얼로그 닫힘 |

### 3-3. 재알림

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 보호자가 아직 읽지 않은 알림장 상세 (관리자 화면) | "재알림" 버튼 표시 |
| 2 | "재알림" 버튼 클릭 | "재알림 요청이 완료되었습니다." 메시지 (MVP: 푸시 미적용) |
| 3 | 보호자가 이미 읽은 알림장 | "재알림" 버튼 미표시 또는 "이미 열람한 보호자입니다." |

---

## 4. 권한 검증

### 4-1. 보호자 → 관리자 전용 기능

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 보호자로 로그인 | - |
| 2 | `/groups/[id]/reports/new` 직접 접근 | 홈으로 리다이렉트 (403) |
| 3 | `/reports/[id]/edit` 직접 접근 | 홈으로 리다이렉트 |
| 4 | `POST /api/reports` 호출 | 403 Forbidden |

### 4-2. 관리자 → 타 원 반려동물

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 관리자 A의 원에 연결되지 않은 반려동물 petId로 `POST /api/reports` | "해당 반려동물에 대한 작성 권한이 없습니다." 403 |

### 4-3. 보호자 → 타 반려동물 알림장

| 단계 | 동작 | 예상 결과 |
|------|------|-----------|
| 1 | 보호자 A로 로그인 | - |
| 2 | 보호자 B의 반려동물 알림장 ID로 `/reports/[id]` 접근 | 404 또는 "알림장을 찾을 수 없습니다." |

---

## 5. API 직접 테스트 (선택)

### cURL 예시

```bash
# 1. 알림장 목록 (보호자)
curl -X GET "http://localhost:3000/api/reports" \
  -H "Cookie: sb-xxx=..."  # Supabase 세션 쿠키

# 2. 알림장 작성 (관리자)
curl -X POST "http://localhost:3000/api/reports" \
  -H "Content-Type: application/json" \
  -H "Cookie: sb-xxx=..." \
  -d '{"petId":"<pet-uuid>","content":"오늘 산책 잘 다녔어요.","mediaUrls":[]}'

# 3. 읽음 처리 (보호자)
curl -X POST "http://localhost:3000/api/reports/<report-id>/read" \
  -H "Cookie: sb-xxx=..."
```

---

## 6. 체크리스트 요약

- [ ] 관리자: 알림장 작성 (텍스트만)
- [ ] 관리자: 알림장 작성 (텍스트 + 사진 3~10장)
- [ ] 관리자: 알림장 수정
- [ ] 관리자: 알림장 삭제
- [ ] 관리자: 재알림 버튼
- [ ] 보호자: 알림장 목록 (미열람 배지)
- [ ] 보호자: 알림장 상세 + 자동 읽음 처리
- [ ] 보호자/관리자: 댓글 작성/조회
- [ ] 댓글 예약 (시계 버튼, 예약 모달, 예약 취소)
- [ ] 댓글 실시간 반영 (Supabase Realtime)
- [ ] 댓글 액션: 내 댓글(복사/수정/삭제), 상대방 댓글(복사만)
- [ ] 댓글 복사 → 입력창 붙여넣기
- [ ] 댓글창 UI (알림창:댓글창 3:2, 스크롤, 새 댓글 시 맨 아래 스크롤)
- [ ] 권한: 보호자 → 관리자 전용 기능 차단
- [ ] 권한: 관리자 → 타 원 반려동물 차단
